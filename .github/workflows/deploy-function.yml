name: Deploy Cloud Function (GCS trigger)

on:
  push:
    branches: [ "main" ]
    paths:
      - "infra/function/**"
      - ".github/workflows/deploy-function.yml"

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Auth to Google Cloud (JSON key)
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Enable required APIs (idempotent)
        run: |
          gcloud services enable cloudbuild.googleapis.com artifactregistry.googleapis.com eventarc.googleapis.com run.googleapis.com

      - name: Deploy Cloud Function
        working-directory: gcp-event-arch-repo/infra/function
        run: |
          gcloud functions deploy wom-gcs-trigger \
            --gen2 \
            --region=us-central1 \
            --runtime=python311 \
            --entry-point=on_gcs_finalize \
            --trigger-event-filters="type=google.cloud.storage.object.v1.finalized" \
            --trigger-event-filters="bucket=${{ secrets.GCS_BUCKET }}" \
            --set-env-vars "PROJECT_ID=${{ secrets.GCP_PROJECT_ID }},DATASET_ID=wom_data,RAW_TABLE_ID=files_raw,PROCESSED_TABLE_ID=files_processed"
